<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hand Tracking Art App</title>
<style>
  body { font-family: sans-serif; background: #000; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; }
  canvas { background: black; border: 1px solid #555; margin-top: 10px; touch-action: none; }
  .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
  button, select, input[type=color], input[type=range] { padding: 5px; }
</style>
</head>
<body>
<h1>Hand Tracking Art App</h1>
<div class="controls">
  <button id="startCamera">Start Camera</button>
  <button id="stopCamera">Stop Camera</button>
  <button id="localDraw">Local Draw</button>
  <input type="color" id="colorPicker" value="#ffffff">
  <input type="range" id="thickness" min="1" max="20" value="5">
  <button id="clear">Clear</button>
</div>
<p id="status"></p>
<video id="video" style="display:none" playsinline></video>
<canvas id="canvas" width="800" height="600"></canvas>

<!-- MediaPipe scripts -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const statusEl = document.getElementById('status');
let lastX = null, lastY = null;
let drawing = false;
let localDrawMode = false;
let cameraInstance = null;
let pinchThreshold = 0.05; // distance between thumb tip & index tip to trigger drawing

function resizeCanvasForDPI() {
  const dpr = window.devicePixelRatio || 1;
  canvas.width = 800 * dpr;
  canvas.height = 600 * dpr;
  canvas.style.width = '800px';
  canvas.style.height = '600px';
  ctx.scale(dpr, dpr);
}
resizeCanvasForDPI();

const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.5
});

hands.onResults(results => {
  // Keep drawings on canvas, only draw hand overlay without clearing art
  if (!localDrawMode) {
    // Hand outlines on top
    if (results.multiHandLandmarks) {
      for (const landmarks of results.multiHandLandmarks) {
        drawConnectors(ctx, landmarks, HAND_CONNECTIONS, { color: '#00FF00', lineWidth: 2 });
        drawLandmarks(ctx, landmarks, { color: '#FF0000', lineWidth: 1 });

        const indexTip = landmarks[8];
        const thumbTip = landmarks[4];
        const dx = indexTip.x - thumbTip.x;
        const dy = indexTip.y - thumbTip.y;
        const distance = Math.sqrt(dx * dx + dy * dy);

        const x = (1 - indexTip.x) * canvas.width / (window.devicePixelRatio || 1);
        const y = indexTip.y * canvas.height / (window.devicePixelRatio || 1);

        if (distance < pinchThreshold) { // Pinch to draw
          if (lastX != null && lastY != null) {
            ctx.strokeStyle = document.getElementById('colorPicker').value;
            ctx.lineWidth = document.getElementById('thickness').value;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
          }
        }
        lastX = x; lastY = y;
      }
    }
  }
});

document.getElementById('startCamera').onclick = async () => {
  try {
    localDrawMode = false;
    cameraInstance = new Camera(video, {
      onFrame: async () => {
        await hands.send({image: video});
      },
      width: 640,
      height: 480
    });
    await cameraInstance.start();
    statusEl.textContent = 'Camera started. Pinch thumb & index finger to draw.';
  } catch (err) {
    if (err.name === 'NotAllowedError') {
      statusEl.textContent = 'Camera permission denied. Use Local Draw or enable camera in browser settings.';
    } else {
      statusEl.textContent = 'Error starting camera: ' + err.message;
    }
  }
};

document.getElementById('stopCamera').onclick = () => {
  if (cameraInstance) {
    cameraInstance.stop();
    statusEl.textContent = 'Camera stopped.';
  }
};

document.getElementById('localDraw').onclick = () => {
  localDrawMode = true;
  statusEl.textContent = 'Local draw mode enabled. Use mouse or touch to draw.';
};

canvas.addEventListener('pointerdown', e => {
  if (localDrawMode) {
    lastX = e.offsetX; lastY = e.offsetY;
    drawing = true;
  }
});

canvas.addEventListener('pointermove', e => {
  if (drawing && localDrawMode) {
    ctx.strokeStyle = document.getElementById('colorPicker').value;
    ctx.lineWidth = document.getElementById('thickness').value;
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
    lastX = e.offsetX;
    lastY = e.offsetY;
  }
});

canvas.addEventListener('pointerup', () => { drawing = false; });

document.getElementById('clear').onclick = () => {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
};
</script>
</body>
</html>
